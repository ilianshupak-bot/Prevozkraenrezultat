<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>EuroTrans - –ú–æ—è—Ç –ü—Ä–æ—Ñ–∏–ª</title>
    <link rel="icon" type="img" href="malukfip.jpg">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- –°–¢–ò–õ–û–í–ï --- */
        .auth-container {
            max-width: 400px;
            margin: 40px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .auth-tab {
            padding: 10px 15px; /* –ú–∞–ª–∫–æ –ø–æ-—Ç–µ—Å–Ω–∏ –∑–∞—Ä–∞–¥–∏ 3-—Ç–∏—è —Ç–∞–± */
            cursor: pointer;
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
        }

        .auth-tab.active {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
        }

        .google-btn {
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 15px;
            transition: 0.3s;
        }
        .google-btn:hover { background: #f9fafb; }

        .form-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .profile-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #eee;
            object-fit: cover;
        }

        .trip-card {
            background: white;
            border-left: 5px solid #2563eb;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        @media (max-width: 600px) {
            .trip-card { flex-direction: column; text-align: left; align-items: flex-start; gap: 10px; }
            .profile-header { flex-direction: column; text-align: center; }
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* –°—Ç–∏–ª –∑–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –∑–∞ –∏–∑–ø—Ä–∞—Ç–µ–Ω –ª–∏–Ω–∫ */
        .success-msg {
            background: #dcfce7;
            color: #166534;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            border: 1px solid #86efac;
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <a href="index.html"><img src="FIP.jpg" alt="EuroTrans Logo" class="logo-img"></a>
            <nav>
                <ul>
                    <li><a href="index.html" id="nav-home">–ù–∞—á–∞–ª–æ</a></li>
                    <li><a href="routes.html" id="nav-routes">–ú–∞—Ä—à—Ä—É—Ç–∏</a></li>
                    <li><a href="schedule.html" id="nav-schedule">–†–∞–∑–ø–∏—Å–∞–Ω–∏–µ</a></li>
                    <li><a href="documents.html" id="nav-docs">–î–æ–∫—É–º–µ–Ω—Ç–∏</a></li>
                    <li><a href="contact.html" id="nav-contact">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a></li>
                    <li><a href="profile.html" class="active" id="nav-profile">–ü—Ä–æ—Ñ–∏–ª</a></li>
                    <li>
                        <select class="lang-select" onchange="changeLanguage(this.value)">
                            <option value="bg">üáßüá¨</option>
                            <option value="en">üá¨üáß</option>
                            <option value="ru">üá∑üá∫</option>
                            <option value="ua">üá∫üá¶</option>
                        </select>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        
        <div id="auth-section" class="auth-container">
            <h2 id="auth-title">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞</h2>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchTab('login')" id="tab-login">–ü–∞—Ä–æ–ª–∞</div>
                <div class="auth-tab" onclick="switchTab('magic')" id="tab-magic">–ë–µ–∑ –ø–∞—Ä–æ–ª–∞</div>
                <div class="auth-tab" onclick="switchTab('register')" id="tab-register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>

            <button class="google-btn" onclick="googleLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                <span id="btn-google">–í—Ö–æ–¥ —Å Google</span>
            </button>

            <p style="margin: 15px 0; color: #999;">- <span id="txt-or">–∏–ª–∏</span> -</p>

            <form id="login-form">
                <input type="email" id="login-email" class="form-input" placeholder="Email" required>
                <input type="password" id="login-pass" class="form-input" placeholder="–ü–∞—Ä–æ–ª–∞" required>
                <button type="submit" class="btn" style="width:100%" id="btn-login-submit">–í–ª–µ–∑</button>
            </form>

            <form id="magic-form" style="display:none;">
                <p id="magic-desc" style="font-size: 0.9em; color: #555; margin-bottom: 10px;">
                    –í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ–π–ª –∏ –Ω–∏–µ —â–µ –≤–∏ –∏–∑–ø—Ä–∞—Ç–∏–º –ª–∏–Ω–∫ –∑–∞ –≤—Ö–æ–¥.
                </p>
                <input type="email" id="magic-email" class="form-input" placeholder="Email" required>
                <button type="submit" class="btn" style="width:100%; background-color: #6366f1;" id="btn-magic-submit">üîó –ò–∑–ø—Ä–∞—Ç–∏ –ª–∏–Ω–∫ –∑–∞ –≤—Ö–æ–¥</button>
                <div id="magic-success" class="success-msg">
                    ‚úÖ –õ–∏–Ω–∫—ä—Ç –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω! –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Å–∏ –ø–æ—â–∞—Ç–∞.
                </div>
            </form>

            <form id="register-form" style="display:none;">
                <input type="email" id="reg-email" class="form-input" placeholder="Email" required>
                <input type="password" id="reg-pass" class="form-input" placeholder="–ü–∞—Ä–æ–ª–∞ (–º–∏–Ω 6 —Å–∏–º–≤–æ–ª–∞)" required>
                <button type="submit" class="btn" style="width:100%; background-color: #059669;" id="btn-reg-submit">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ</button>
            </form>

            <p id="error-msg" style="color: red; margin-top: 10px; display: none;"></p>
        </div>

        <div id="profile-section" style="display: none;">
            
            <div class="profile-header">
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" id="user-img" class="profile-pic" alt="User">
                <div style="flex: 1;">
                    <h2 id="user-name">...</h2>
                    <p id="user-email" style="color: #666;">...</p>
                    
                    <div style="margin-top: 10px; background: #f3f4f6; padding: 10px; border-radius: 8px; display: inline-block;">
                        <label style="font-size: 0.9em; color: #4b5563;" id="lbl-phone-link">–°–≤—ä—Ä–∂–µ—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∑–∞ –∏—Å—Ç–æ—Ä–∏—è:</label>
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <input type="text" id="profile-phone" placeholder="+359..." style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="savePhoneAndLoadTrips()" class="btn" style="padding: 5px 10px; font-size: 0.9em;" id="btn-save-phone">–¢—ä—Ä—Å–∏</button>
                        </div>
                    </div>
                </div>
                <button onclick="logout()" class="btn" style="background-color: #ef4444;" id="btn-logout">–ò–∑—Ö–æ–¥</button>
            </div>

            <h2 id="history-title">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –ø—ä—Ç—É–≤–∞–Ω–∏—è—Ç–∞</h2>
            <div id="trips-container"></div>
        </div>

    </main>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        // --- –ü–†–ï–í–û–î–ò ---
        const translations = {
            'bg': {
                'nav-profile': '–ü—Ä–æ—Ñ–∏–ª', 'auth-title': '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞',
                'tab-login': '–ü–∞—Ä–æ–ª–∞', 'tab-magic': '–ë–µ–∑ –ø–∞—Ä–æ–ª–∞', 'tab-register': '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                'btn-google': '–í—Ö–æ–¥ —Å Google', 'txt-or': '–∏–ª–∏',
                'btn-login-submit': '–í–ª–µ–∑', 'btn-magic-submit': 'üîó –ò–∑–ø—Ä–∞—Ç–∏ –ª–∏–Ω–∫ –∑–∞ –≤—Ö–æ–¥', 'btn-reg-submit': '–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ',
                'magic-desc': '–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ–π–ª –∏ –Ω–∏–µ —â–µ –≤–∏ –∏–∑–ø—Ä–∞—Ç–∏–º –ª–∏–Ω–∫ –∑–∞ –≤—Ö–æ–¥.',
                'magic-sent-msg': '‚úÖ –õ–∏–Ω–∫—ä—Ç –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω! –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Å–∏ –ø–æ—â–∞—Ç–∞.',
                'lbl-phone-link': '–í—ä–≤–µ–¥–µ—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, —Å –∫–æ–π—Ç–æ —Å—Ç–µ –ø—Ä–∞–≤–∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏:',
                'btn-save-phone': '–¢—ä—Ä—Å–∏', 'btn-logout': '–ò–∑—Ö–æ–¥',
                'history-title': '–ú–æ–∏—Ç–µ –ø—ä—Ç—É–≤–∞–Ω–∏—è',
                'loading-trips': '–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏.',
                'prompt-email': '–ú–æ–ª—è –ø–æ—Ç–≤—ä—Ä–¥–µ—Ç–µ –≤–∞—à–∏—è –∏–º–µ–π–ª –∑–∞ –≤—Ö–æ–¥:'
            },
            'en': {
                'nav-profile': 'Profile', 'auth-title': 'System Login',
                'tab-login': 'Password', 'tab-magic': 'Passwordless', 'tab-register': 'Register',
                'btn-google': 'Sign in with Google', 'txt-or': 'or',
                'btn-login-submit': 'Login', 'btn-magic-submit': 'üîó Send Login Link', 'btn-reg-submit': 'Register',
                'magic-desc': 'Enter your email and we will send you a login link.',
                'magic-sent-msg': '‚úÖ Link sent! Check your inbox.',
                'lbl-phone-link': 'Enter phone number used for bookings:',
                'btn-save-phone': 'Search', 'btn-logout': 'Logout',
                'history-title': 'My Trips',
                'loading-trips': 'No bookings found.',
                'prompt-email': 'Please confirm your email for login:'
            },
            'ru': {
                'nav-profile': '–ü—Ä–æ—Ñ–∏–ª—å', 'auth-title': '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É',
                'tab-login': '–ü–∞—Ä–æ–ª—å', 'tab-magic': '–ë–µ–∑ –ø–∞—Ä–æ–ª—è', 'tab-register': '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                'btn-google': '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google', 'txt-or': '–∏–ª–∏',
                'btn-login-submit': '–í–æ–π—Ç–∏', 'btn-magic-submit': 'üîó –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É', 'btn-reg-submit': '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è',
                'magic-desc': '–í–≤–µ–¥–∏—Ç–µ email, –∏ –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞.',
                'magic-sent-msg': '‚úÖ –°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É.',
                'lbl-phone-link': '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:',
                'btn-save-phone': '–ù–∞–π—Ç–∏', 'btn-logout': '–í—ã—Ö–æ–¥',
                'history-title': '–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏',
                'loading-trips': '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.',
                'prompt-email': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email:'
            },
            'ua': {
                'nav-profile': '–ü—Ä–æ—Ñ—ñ–ª—å', 'auth-title': '–í—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É',
                'tab-login': '–ü–∞—Ä–æ–ª—å', 'tab-magic': '–ë–µ–∑ –ø–∞—Ä–æ–ª—è', 'tab-register': '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è',
                'btn-google': '–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google', 'txt-or': '–∞–±–æ',
                'btn-login-submit': '–£–≤—ñ–π—Ç–∏', 'btn-magic-submit': 'üîó –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è', 'btn-reg-submit': '–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è',
                'magic-desc': '–í–≤–µ–¥—ñ—Ç—å email, —ñ –º–∏ –Ω–∞–¥—ñ—à–ª–µ–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≤—Ö–æ–¥—É.',
                'magic-sent-msg': '‚úÖ –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—à—Ç—É.',
                'lbl-phone-link': '–í–≤–µ–¥—ñ—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –ø–æ—à—É–∫—É –±—Ä–æ–Ω—é–≤–∞–Ω—å:',
                'btn-save-phone': '–ó–Ω–∞–π—Ç–∏', 'btn-logout': '–í–∏—Ö—ñ–¥',
                'history-title': '–ú–æ—ó –ø–æ—ó–∑–¥–∫–∏',
                'loading-trips': '–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.',
                'prompt-email': '–ë—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –≤–∞—à email:'
            }
        };

        let currentLang = 'bg';
        function changeLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            for (let key in t) {
                let el = document.getElementById(key);
                if (el) el.innerText = t[key];
            }
            // –°–ø–µ—Ü–∏–∞–ª–Ω–æ –∑–∞ success —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ
            document.getElementById('magic-success').innerText = t['magic-sent-msg'];
            localStorage.setItem('preferredLang', lang);
            document.querySelectorAll('.lang-select').forEach(sel => sel.value = lang);
        }

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBGEPxa0rGPyByiY8Tp3GaiflGnApQocgU",
            authDomain: "prevozmoldovabulgaria.firebaseapp.com",
            projectId: "prevozmoldovabulgaria",
            storageBucket: "prevozmoldovabulgaria.firebasestorage.app",
            messagingSenderId: "970743272899",
            appId: "1:970743272899:web:c27df38bd186bd7e7a1976",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- UI –õ–û–ì–ò–ö–ê ---
        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('magic-form').style.display = 'none';
            document.getElementById('error-msg').style.display = 'none';

            if (tab === 'login') document.getElementById('login-form').style.display = 'block';
            else if (tab === 'magic') document.getElementById('magic-form').style.display = 'block';
            else document.getElementById('register-form').style.display = 'block';
        }

        // --- AUTH –°–™–ë–ò–¢–ò–Ø (–ü–†–û–í–ï–†–ö–ê –ù–ê –õ–ò–ù–ö) ---
        window.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('preferredLang') || 'bg';
            changeLanguage(savedLang);

            // 1. –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç —Ç–æ–∫—É-—â–æ –µ –∫–ª–∏–∫–Ω–∞–ª –Ω–∞ –ª–∏–Ω–∫–∞ –æ—Ç –º–µ–π–ª–∞
            if (auth.isSignInWithEmailLink(window.location.href)) {
                
                let email = window.localStorage.getItem('emailForSignIn');
                
                // –ê–∫–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –æ—Ç–≤–æ—Ä–∏–ª –ª–∏–Ω–∫–∞ –Ω–∞ –¥—Ä—É–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, —Ç—Ä—è–±–≤–∞ –¥–∞ –≥–æ –ø–∏—Ç–∞–º–µ –∑–∞ –º–µ–π–ª–∞
                if (!email) {
                    email = window.prompt(translations[currentLang]['prompt-email']);
                }

                if (email) {
                    auth.signInWithEmailLink(email, window.location.href)
                        .then((result) => {
                            window.localStorage.removeItem('emailForSignIn');
                            // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ –≥—Ä–æ–∑–Ω–∏—è URL
                            window.history.replaceState({}, document.title, "profile.html");
                            // –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –ª–æ–≥–Ω–∞—Ç, onAuthStateChanged —â–µ —Å–µ –∑–∞–¥–µ–π—Å—Ç–≤–∞ –¥–æ–ª—É
                        })
                        .catch((error) => {
                            alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤–ª–∏–∑–∞–Ω–µ: " + error.message);
                        });
                }
            }
        });

        // –û—Å–Ω–æ–≤–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –µ –ª–æ–≥–Ω–∞—Ç
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('profile-section').style.display = 'block';
                
                document.getElementById('user-name').innerText = user.displayName || user.email.split('@')[0];
                document.getElementById('user-email').innerText = user.email;
                if(user.photoURL) document.getElementById('user-img').src = user.photoURL;

                const savedPhone = localStorage.getItem('userPhone_' + user.uid);
                if (savedPhone) {
                    document.getElementById('profile-phone').value = savedPhone;
                    loadTrips(savedPhone);
                }
            } else {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('profile-section').style.display = 'none';
            }
        });

        // --- LOGIN/REGISTER FUNCTIONS ---

        // Google
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(handleError);
        }

        // Email & Password Login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            auth.signInWithEmailAndPassword(email, pass).catch(handleError);
        });

        // --- MAGIC LINK SENDING ---
        document.getElementById('magic-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('magic-email').value;
            const btn = document.getElementById('btn-magic-submit');
            
            const actionCodeSettings = {
                // URL-—ä—Ç, –Ω–∞ –∫–æ–π—Ç–æ –¥–∞ —Å–µ –≤—ä—Ä–Ω–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è. –¢—Ä—è–±–≤–∞ –¥–∞ –µ —Ç–æ—á–Ω–æ —Ç–æ–∑–∏ —Ñ–∞–π–ª.
                url: window.location.href, 
                handleCodeInApp: true
            };

            btn.disabled = true;
            btn.innerText = "–ò–∑–ø—Ä–∞—â–∞–Ω–µ...";

            auth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    // –ó–∞–ø–∞–∑–≤–∞–º–µ –∏–º–µ–π–ª–∞, –∑–∞ –¥–∞ –Ω–µ –≥–æ –ø–∏—Ç–∞–º–µ –ø–∞–∫ –∫–∞—Ç–æ —Å–µ –≤—ä—Ä–Ω–µ
                    window.localStorage.setItem('emailForSignIn', email);
                    document.getElementById('magic-success').style.display = 'block';
                    btn.innerText = "–ò–∑–ø—Ä–∞—Ç–µ–Ω–æ";
                })
                .catch((error) => {
                    handleError(error);
                    btn.disabled = false;
                    btn.innerText = "–û–ø–∏—Ç–∞–π –ø–∞–∫";
                });
        });

        // Register
        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            if(pass.length < 6) { alert("–ü–∞—Ä–æ–ª–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–∞"); return; }
            auth.createUserWithEmailAndPassword(email, pass).catch(handleError);
        });

        // Logout
        function logout() {
            auth.signOut().then(() => location.reload());
        }

        function handleError(error) {
            const errBox = document.getElementById('error-msg');
            errBox.style.display = 'block';
            errBox.innerText = "–ì—Ä–µ—à–∫–∞: " + error.message;
        }

        // --- HISTORY LOGIC ---
        function savePhoneAndLoadTrips() {
            const phone = document.getElementById('profile-phone').value.trim();
            const user = auth.currentUser;
            if(!phone) return;
            if(user) localStorage.setItem('userPhone_' + user.uid, phone);
            loadTrips(phone);
        }

        function loadTrips(phoneNumber) {
            const container = document.getElementById('trips-container');
            container.innerHTML = '<p>Searching...</p>';
            db.collection("reservations").where("phone", "==", phoneNumber).orderBy("time", "desc").get()
              .then((querySnapshot) => {
                  container.innerHTML = '';
                  if (querySnapshot.empty) {
                      container.innerHTML = `<p style="color:#666;">${translations[currentLang]['loading-trips']}</p>`;
                      return;
                  }
                  querySnapshot.forEach((doc) => {
                      const data = doc.data();
                      let routeName = data.route === 'sofia-moldova' ? '–°–æ—Ñ–∏—è ‚ûî –ú–æ–ª–¥–æ–≤–∞' : '–ú–æ–ª–¥–æ–≤–∞ ‚ûî –°–æ—Ñ–∏—è';
                      const card = document.createElement('div');
                      card.className = 'trip-card';
                      card.innerHTML = `
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: #1f2937;"><i class="fas fa-bus"></i> ${routeName}</h3>
                            <p style="margin:0; color:#666;">üìÖ ${data.date} <br> üïí <small>${data.time}</small></p>
                        </div>
                        <div><span class="status-badge">‚úÖ OK</span></div>
                      `;
                      container.appendChild(card);
                  });
              })
              .catch((error) => {
                  console.log(error);
                  container.innerHTML = `<p style="color:red">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∏–Ω–¥–µ–∫—Å–∞.</p>`;
              });
        }
    </script>
</body>
</html>